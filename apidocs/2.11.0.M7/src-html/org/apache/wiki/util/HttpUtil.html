<!DOCTYPE HTML>
<html lang="es">
<head>
<!-- Generated by javadoc -->
<title>Source code</title>
<meta name="description" content="source: package: org.apache.wiki.util, class: HttpUtil">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line.1">/* </span>
<span class="source-line-no">002</span><span id="line.2">    Licensed to the Apache Software Foundation (ASF) under one</span>
<span class="source-line-no">003</span><span id="line.3">    or more contributor license agreements.  See the NOTICE file</span>
<span class="source-line-no">004</span><span id="line.4">    distributed with this work for additional information</span>
<span class="source-line-no">005</span><span id="line.5">    regarding copyright ownership.  The ASF licenses this file</span>
<span class="source-line-no">006</span><span id="line.6">    to you under the Apache License, Version 2.0 (the</span>
<span class="source-line-no">007</span><span id="line.7">    "License"); you may not use this file except in compliance</span>
<span class="source-line-no">008</span><span id="line.8">    with the License.  You may obtain a copy of the License at</span>
<span class="source-line-no">009</span><span id="line.9"></span>
<span class="source-line-no">010</span><span id="line.10">       http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="source-line-no">011</span><span id="line.11"></span>
<span class="source-line-no">012</span><span id="line.12">    Unless required by applicable law or agreed to in writing,</span>
<span class="source-line-no">013</span><span id="line.13">    software distributed under the License is distributed on an</span>
<span class="source-line-no">014</span><span id="line.14">    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span>
<span class="source-line-no">015</span><span id="line.15">    KIND, either express or implied.  See the License for the</span>
<span class="source-line-no">016</span><span id="line.16">    specific language governing permissions and limitations</span>
<span class="source-line-no">017</span><span id="line.17">    under the License.  </span>
<span class="source-line-no">018</span><span id="line.18"> */</span>
<span class="source-line-no">019</span><span id="line.19">package org.apache.wiki.util;</span>
<span class="source-line-no">020</span><span id="line.20"></span>
<span class="source-line-no">021</span><span id="line.21">import org.apache.commons.lang3.StringUtils;</span>
<span class="source-line-no">022</span><span id="line.22">import org.apache.log4j.Logger;</span>
<span class="source-line-no">023</span><span id="line.23"></span>
<span class="source-line-no">024</span><span id="line.24">import javax.servlet.http.Cookie;</span>
<span class="source-line-no">025</span><span id="line.25">import javax.servlet.http.HttpServletRequest;</span>
<span class="source-line-no">026</span><span id="line.26">import java.nio.charset.Charset;</span>
<span class="source-line-no">027</span><span id="line.27">import java.nio.charset.StandardCharsets;</span>
<span class="source-line-no">028</span><span id="line.28">import java.text.DateFormat;</span>
<span class="source-line-no">029</span><span id="line.29">import java.text.ParseException;</span>
<span class="source-line-no">030</span><span id="line.30">import java.text.SimpleDateFormat;</span>
<span class="source-line-no">031</span><span id="line.31">import java.util.Date;</span>
<span class="source-line-no">032</span><span id="line.32"></span>
<span class="source-line-no">033</span><span id="line.33"></span>
<span class="source-line-no">034</span><span id="line.34">/**</span>
<span class="source-line-no">035</span><span id="line.35"> *  Contains useful utilities for some common HTTP tasks.</span>
<span class="source-line-no">036</span><span id="line.36"> *</span>
<span class="source-line-no">037</span><span id="line.37"> *  @since 2.1.61.</span>
<span class="source-line-no">038</span><span id="line.38"> */</span>
<span class="source-line-no">039</span><span id="line.39">public final class HttpUtil {</span>
<span class="source-line-no">040</span><span id="line.40"></span>
<span class="source-line-no">041</span><span id="line.41">    private static final Logger log = Logger.getLogger( HttpUtil.class );</span>
<span class="source-line-no">042</span><span id="line.42">    private static final int    ONE                   = 48;</span>
<span class="source-line-no">043</span><span id="line.43">    private static final int    NINE                  = 57;</span>
<span class="source-line-no">044</span><span id="line.44">    private static final int    DOT                   = 46;</span>
<span class="source-line-no">045</span><span id="line.45">    </span>
<span class="source-line-no">046</span><span id="line.46">    /** Private constructor to prevent direct instantiation. */</span>
<span class="source-line-no">047</span><span id="line.47">    private HttpUtil() {</span>
<span class="source-line-no">048</span><span id="line.48">    }</span>
<span class="source-line-no">049</span><span id="line.49">    </span>
<span class="source-line-no">050</span><span id="line.50">    /**</span>
<span class="source-line-no">051</span><span id="line.51">     * returns the remote address by looking into {@code x-forwarded-for} header or, if unavailable, </span>
<span class="source-line-no">052</span><span id="line.52">     * into {@link HttpServletRequest#getRemoteAddr()}.</span>
<span class="source-line-no">053</span><span id="line.53">     * </span>
<span class="source-line-no">054</span><span id="line.54">     * @param req http request</span>
<span class="source-line-no">055</span><span id="line.55">     * @return remote address associated to the request.</span>
<span class="source-line-no">056</span><span id="line.56">     */</span>
<span class="source-line-no">057</span><span id="line.57">    public static String getRemoteAddress( final HttpServletRequest req ) {</span>
<span class="source-line-no">058</span><span id="line.58">        return StringUtils.isNotEmpty ( req.getHeader( "X-Forwarded-For" ) ) ? req.getHeader( "X-Forwarded-For" ) : </span>
<span class="source-line-no">059</span><span id="line.59">                                                                                      req.getRemoteAddr();</span>
<span class="source-line-no">060</span><span id="line.60">    }</span>
<span class="source-line-no">061</span><span id="line.61"></span>
<span class="source-line-no">062</span><span id="line.62">    /**</span>
<span class="source-line-no">063</span><span id="line.63">     *  Attempts to retrieve the given cookie value from the request. Returns the string value (which may or may not be decoded</span>
<span class="source-line-no">064</span><span id="line.64">     *  correctly, depending on browser!), or null if the cookie is not found. The algorithm will automatically trim leading</span>
<span class="source-line-no">065</span><span id="line.65">     *  and trailing double quotes, if found.</span>
<span class="source-line-no">066</span><span id="line.66">     *</span>
<span class="source-line-no">067</span><span id="line.67">     *  @param request The current request</span>
<span class="source-line-no">068</span><span id="line.68">     *  @param cookieName The name of the cookie to fetch.</span>
<span class="source-line-no">069</span><span id="line.69">     *  @return Value of the cookie, or null, if there is no such cookie.</span>
<span class="source-line-no">070</span><span id="line.70">     */</span>
<span class="source-line-no">071</span><span id="line.71">    public static String retrieveCookieValue( final HttpServletRequest request, final String cookieName ) {</span>
<span class="source-line-no">072</span><span id="line.72">        final Cookie[] cookies = request.getCookies();</span>
<span class="source-line-no">073</span><span id="line.73">        if( cookies != null ) {</span>
<span class="source-line-no">074</span><span id="line.74">            for( final Cookie cookie : cookies ) {</span>
<span class="source-line-no">075</span><span id="line.75">                if( cookie.getName().equals( cookieName ) ) {</span>
<span class="source-line-no">076</span><span id="line.76">                    String value = cookie.getValue();</span>
<span class="source-line-no">077</span><span id="line.77">                    if( value == null || value.length() == 0 ) {</span>
<span class="source-line-no">078</span><span id="line.78">                        return null;</span>
<span class="source-line-no">079</span><span id="line.79">                    }</span>
<span class="source-line-no">080</span><span id="line.80">                    if( value.charAt( 0 ) == '"' &amp;&amp; value.charAt( value.length() - 1 ) == '"' ) {</span>
<span class="source-line-no">081</span><span id="line.81">                        value = value.substring( 1, value.length() - 1 );</span>
<span class="source-line-no">082</span><span id="line.82">                    }</span>
<span class="source-line-no">083</span><span id="line.83">                    return value;</span>
<span class="source-line-no">084</span><span id="line.84">                }</span>
<span class="source-line-no">085</span><span id="line.85">            }</span>
<span class="source-line-no">086</span><span id="line.86">        }</span>
<span class="source-line-no">087</span><span id="line.87"></span>
<span class="source-line-no">088</span><span id="line.88">        return null;</span>
<span class="source-line-no">089</span><span id="line.89">    }</span>
<span class="source-line-no">090</span><span id="line.90"></span>
<span class="source-line-no">091</span><span id="line.91">    /**</span>
<span class="source-line-no">092</span><span id="line.92">     *  Creates an ETag based on page information. An ETag is unique to each page and version, so it can be used to check if the page has</span>
<span class="source-line-no">093</span><span id="line.93">     *  changed. Do not assume that the ETag is in any particular format.</span>
<span class="source-line-no">094</span><span id="line.94">     *  </span>
<span class="source-line-no">095</span><span id="line.95">     *  @param pageName  The page name for which the ETag should be created.</span>
<span class="source-line-no">096</span><span id="line.96">     *  @param lastModified  The page last modified date for which the ETag should be created.</span>
<span class="source-line-no">097</span><span id="line.97">     *  @return A String depiction of an ETag.</span>
<span class="source-line-no">098</span><span id="line.98">     */</span>
<span class="source-line-no">099</span><span id="line.99">    public static String createETag( final String pageName, final Date lastModified ) {</span>
<span class="source-line-no">100</span><span id="line.100">        return Long.toString( pageName.hashCode() ^ lastModified.getTime() );</span>
<span class="source-line-no">101</span><span id="line.101">    }</span>
<span class="source-line-no">102</span><span id="line.102">    </span>
<span class="source-line-no">103</span><span id="line.103">    /**</span>
<span class="source-line-no">104</span><span id="line.104">     *  If returns true, then should return a 304 (HTTP_NOT_MODIFIED)</span>
<span class="source-line-no">105</span><span id="line.105">     *</span>
<span class="source-line-no">106</span><span id="line.106">     *  @param req the HTTP request</span>
<span class="source-line-no">107</span><span id="line.107">     *  @param pageName the wiki page name to check for</span>
<span class="source-line-no">108</span><span id="line.108">     *  @param lastModified the last modified date of the wiki page to check for</span>
<span class="source-line-no">109</span><span id="line.109">     *  @return the result of the check</span>
<span class="source-line-no">110</span><span id="line.110">     */</span>
<span class="source-line-no">111</span><span id="line.111">    public static boolean checkFor304( final HttpServletRequest req, final String pageName, final Date lastModified ) {</span>
<span class="source-line-no">112</span><span id="line.112">        // We'll do some handling for CONDITIONAL GET (and return a 304). If the client has set the following headers, do not try for a 304.</span>
<span class="source-line-no">113</span><span id="line.113">        //    pragma: no-cache</span>
<span class="source-line-no">114</span><span id="line.114">        //    cache-control: no-cache</span>
<span class="source-line-no">115</span><span id="line.115">        if( "no-cache".equalsIgnoreCase( req.getHeader( "Pragma" ) )</span>
<span class="source-line-no">116</span><span id="line.116">            || "no-cache".equalsIgnoreCase( req.getHeader( "cache-control" ) ) ) {</span>
<span class="source-line-no">117</span><span id="line.117">            // Wants specifically a fresh copy</span>
<span class="source-line-no">118</span><span id="line.118">        } else {</span>
<span class="source-line-no">119</span><span id="line.119">            //  HTTP 1.1 ETags go first</span>
<span class="source-line-no">120</span><span id="line.120">            final String thisTag = createETag( pageName, lastModified );</span>
<span class="source-line-no">121</span><span id="line.121">            final String eTag = req.getHeader( "If-None-Match" );</span>
<span class="source-line-no">122</span><span id="line.122">            </span>
<span class="source-line-no">123</span><span id="line.123">            if( eTag != null &amp;&amp; eTag.equals(thisTag) ) {</span>
<span class="source-line-no">124</span><span id="line.124">                return true;</span>
<span class="source-line-no">125</span><span id="line.125">            }</span>
<span class="source-line-no">126</span><span id="line.126">            </span>
<span class="source-line-no">127</span><span id="line.127">            //  Next, try if-modified-since</span>
<span class="source-line-no">128</span><span id="line.128">            final DateFormat rfcDateFormat = new SimpleDateFormat( "EEE, dd MMM yyyy HH:mm:ss z" );</span>
<span class="source-line-no">129</span><span id="line.129"></span>
<span class="source-line-no">130</span><span id="line.130">            try {</span>
<span class="source-line-no">131</span><span id="line.131">                final long ifModifiedSince = req.getDateHeader( "If-Modified-Since" );</span>
<span class="source-line-no">132</span><span id="line.132"></span>
<span class="source-line-no">133</span><span id="line.133">                if( ifModifiedSince != -1 ) {</span>
<span class="source-line-no">134</span><span id="line.134">                    final long lastModifiedTime = lastModified.getTime();</span>
<span class="source-line-no">135</span><span id="line.135">                    if( lastModifiedTime &lt;= ifModifiedSince ) {</span>
<span class="source-line-no">136</span><span id="line.136">                        return true;</span>
<span class="source-line-no">137</span><span id="line.137">                    }</span>
<span class="source-line-no">138</span><span id="line.138">                } else {</span>
<span class="source-line-no">139</span><span id="line.139">                    try {</span>
<span class="source-line-no">140</span><span id="line.140">                        final String s = req.getHeader("If-Modified-Since");</span>
<span class="source-line-no">141</span><span id="line.141">                        if( s != null ) {</span>
<span class="source-line-no">142</span><span id="line.142">                            final Date ifModifiedSinceDate = rfcDateFormat.parse( s );</span>
<span class="source-line-no">143</span><span id="line.143">                            if( lastModified.before( ifModifiedSinceDate ) ) {</span>
<span class="source-line-no">144</span><span id="line.144">                                return true;</span>
<span class="source-line-no">145</span><span id="line.145">                            }</span>
<span class="source-line-no">146</span><span id="line.146">                        }</span>
<span class="source-line-no">147</span><span id="line.147">                    } catch( final ParseException e ) {</span>
<span class="source-line-no">148</span><span id="line.148">                        log.warn( e.getLocalizedMessage(), e );</span>
<span class="source-line-no">149</span><span id="line.149">                    }</span>
<span class="source-line-no">150</span><span id="line.150">                }</span>
<span class="source-line-no">151</span><span id="line.151">            } catch( final IllegalArgumentException e ) {</span>
<span class="source-line-no">152</span><span id="line.152">                // Illegal date/time header format.  We fail quietly, and return false.</span>
<span class="source-line-no">153</span><span id="line.153">                // FIXME: Should really move to ETags.</span>
<span class="source-line-no">154</span><span id="line.154">            }</span>
<span class="source-line-no">155</span><span id="line.155">        }</span>
<span class="source-line-no">156</span><span id="line.156">         </span>
<span class="source-line-no">157</span><span id="line.157">        return false;</span>
<span class="source-line-no">158</span><span id="line.158">    }</span>
<span class="source-line-no">159</span><span id="line.159"></span>
<span class="source-line-no">160</span><span id="line.160">    /**</span>
<span class="source-line-no">161</span><span id="line.161">     * Attempts to form a valid URI based on the string given.  Currently it can guess email addresses (mailto:).  If nothing else is given,</span>
<span class="source-line-no">162</span><span id="line.162">     * it assumes it to be an http:// url.</span>
<span class="source-line-no">163</span><span id="line.163">     * </span>
<span class="source-line-no">164</span><span id="line.164">     * @param uri  URI to take a poke at</span>
<span class="source-line-no">165</span><span id="line.165">     * @return Possibly a valid URI</span>
<span class="source-line-no">166</span><span id="line.166">     * @since 2.2.8</span>
<span class="source-line-no">167</span><span id="line.167">     */</span>
<span class="source-line-no">168</span><span id="line.168">    public static String guessValidURI( String uri ) {</span>
<span class="source-line-no">169</span><span id="line.169">        if( uri.indexOf( '@' ) != -1 ) {</span>
<span class="source-line-no">170</span><span id="line.170">            if( !uri.startsWith( "mailto:" ) ) {</span>
<span class="source-line-no">171</span><span id="line.171">                // Assume this is an email address</span>
<span class="source-line-no">172</span><span id="line.172">                uri = "mailto:" + uri;</span>
<span class="source-line-no">173</span><span id="line.173">            }</span>
<span class="source-line-no">174</span><span id="line.174">        } else if( notBeginningWithHttpOrHttps( uri ) ) {</span>
<span class="source-line-no">175</span><span id="line.175">            uri = "http://" + uri;</span>
<span class="source-line-no">176</span><span id="line.176">        }</span>
<span class="source-line-no">177</span><span id="line.177">        </span>
<span class="source-line-no">178</span><span id="line.178">        return uri;</span>
<span class="source-line-no">179</span><span id="line.179">    }</span>
<span class="source-line-no">180</span><span id="line.180"></span>
<span class="source-line-no">181</span><span id="line.181">    static boolean notBeginningWithHttpOrHttps( final String uri ) {</span>
<span class="source-line-no">182</span><span id="line.182">        return uri.length() &gt; 0 &amp;&amp; !( uri.startsWith("http://" ) || uri.startsWith( "https://" ) );</span>
<span class="source-line-no">183</span><span id="line.183">    }</span>
<span class="source-line-no">184</span><span id="line.184"></span>
<span class="source-line-no">185</span><span id="line.185">    /**</span>
<span class="source-line-no">186</span><span id="line.186">     *  Returns the query string (the portion after the question mark).</span>
<span class="source-line-no">187</span><span id="line.187">     *</span>
<span class="source-line-no">188</span><span id="line.188">     *  @param request The HTTP request to parse.</span>
<span class="source-line-no">189</span><span id="line.189">     *  @return The query string. If the query string is null, returns an empty string.</span>
<span class="source-line-no">190</span><span id="line.190">     *  @since 2.1.3 (method moved from WikiEngine on 2.11.0.M6)</span>
<span class="source-line-no">191</span><span id="line.191">     */</span>
<span class="source-line-no">192</span><span id="line.192">    public static String safeGetQueryString( final HttpServletRequest request, final Charset contentEncoding ) {</span>
<span class="source-line-no">193</span><span id="line.193">        if( request == null ) {</span>
<span class="source-line-no">194</span><span id="line.194">            return "";</span>
<span class="source-line-no">195</span><span id="line.195">        }</span>
<span class="source-line-no">196</span><span id="line.196"></span>
<span class="source-line-no">197</span><span id="line.197">        String res = request.getQueryString();</span>
<span class="source-line-no">198</span><span id="line.198">        if( res != null ) {</span>
<span class="source-line-no">199</span><span id="line.199">            res = new String( res.getBytes( StandardCharsets.ISO_8859_1 ), contentEncoding );</span>
<span class="source-line-no">200</span><span id="line.200"></span>
<span class="source-line-no">201</span><span id="line.201">            //</span>
<span class="source-line-no">202</span><span id="line.202">            // Ensure that the 'page=xyz' attribute is removed</span>
<span class="source-line-no">203</span><span id="line.203">            // FIXME: Is it really the mandate of this routine to do that?</span>
<span class="source-line-no">204</span><span id="line.204">            //</span>
<span class="source-line-no">205</span><span id="line.205">            final int pos1 = res.indexOf( "page=" );</span>
<span class="source-line-no">206</span><span id="line.206">            if( pos1 &gt;= 0 ) {</span>
<span class="source-line-no">207</span><span id="line.207">                String tmpRes = res.substring( 0, pos1 );</span>
<span class="source-line-no">208</span><span id="line.208">                final int pos2 = res.indexOf( '&amp;', pos1 ) + 1;</span>
<span class="source-line-no">209</span><span id="line.209">                if( ( pos2 &gt; 0 ) &amp;&amp; ( pos2 &lt; res.length() ) ) {</span>
<span class="source-line-no">210</span><span id="line.210">                    tmpRes = tmpRes + res.substring( pos2 );</span>
<span class="source-line-no">211</span><span id="line.211">                }</span>
<span class="source-line-no">212</span><span id="line.212">                res = tmpRes;</span>
<span class="source-line-no">213</span><span id="line.213">            }</span>
<span class="source-line-no">214</span><span id="line.214">        }</span>
<span class="source-line-no">215</span><span id="line.215"></span>
<span class="source-line-no">216</span><span id="line.216">        return res;</span>
<span class="source-line-no">217</span><span id="line.217">    }</span>
<span class="source-line-no">218</span><span id="line.218"></span>
<span class="source-line-no">219</span><span id="line.219">    /**</span>
<span class="source-line-no">220</span><span id="line.220">     * Verifies whether a String represents an IPv4 address. The algorithm is extremely efficient and does not allocate any objects.</span>
<span class="source-line-no">221</span><span id="line.221">     *</span>
<span class="source-line-no">222</span><span id="line.222">     * @param name the address to test</span>
<span class="source-line-no">223</span><span id="line.223">     * @return the result</span>
<span class="source-line-no">224</span><span id="line.224">     */</span>
<span class="source-line-no">225</span><span id="line.225">    public static boolean isIPV4Address( final String name ) {</span>
<span class="source-line-no">226</span><span id="line.226">        if( StringUtils.isEmpty( name ) || name.charAt( 0 ) == DOT || name.charAt( name.length() - 1 ) == DOT ) {</span>
<span class="source-line-no">227</span><span id="line.227">            return false;</span>
<span class="source-line-no">228</span><span id="line.228">        }</span>
<span class="source-line-no">229</span><span id="line.229"></span>
<span class="source-line-no">230</span><span id="line.230">        final int[] addr = new int[] { 0, 0, 0, 0 };</span>
<span class="source-line-no">231</span><span id="line.231">        int currentOctet = 0;</span>
<span class="source-line-no">232</span><span id="line.232">        for( int i = 0; i &lt; name.length(); i++ ) {</span>
<span class="source-line-no">233</span><span id="line.233">            if( currentOctet &gt; 3 ) {</span>
<span class="source-line-no">234</span><span id="line.234">                return false;</span>
<span class="source-line-no">235</span><span id="line.235">            }</span>
<span class="source-line-no">236</span><span id="line.236">            final int ch = name.charAt( i );</span>
<span class="source-line-no">237</span><span id="line.237">            final boolean isDigit = ch &gt;= ONE &amp;&amp; ch &lt;= NINE;</span>
<span class="source-line-no">238</span><span id="line.238">            final boolean isDot = ch == DOT;</span>
<span class="source-line-no">239</span><span id="line.239">            if( !isDigit &amp;&amp; !isDot ) {</span>
<span class="source-line-no">240</span><span id="line.240">                return false;</span>
<span class="source-line-no">241</span><span id="line.241">            }</span>
<span class="source-line-no">242</span><span id="line.242">            if( isDigit ) {</span>
<span class="source-line-no">243</span><span id="line.243">                addr[ currentOctet ] = 10 * addr[ currentOctet ] + ( ch - ONE );</span>
<span class="source-line-no">244</span><span id="line.244">                if( addr[ currentOctet ] &gt; 255 ) {</span>
<span class="source-line-no">245</span><span id="line.245">                    return false;</span>
<span class="source-line-no">246</span><span id="line.246">                }</span>
<span class="source-line-no">247</span><span id="line.247">            } else if( name.charAt( i - 1 ) == DOT ) {</span>
<span class="source-line-no">248</span><span id="line.248">                return false;</span>
<span class="source-line-no">249</span><span id="line.249">            } else {</span>
<span class="source-line-no">250</span><span id="line.250">                currentOctet++;</span>
<span class="source-line-no">251</span><span id="line.251">            }</span>
<span class="source-line-no">252</span><span id="line.252">        }</span>
<span class="source-line-no">253</span><span id="line.253">        return currentOctet == 3;</span>
<span class="source-line-no">254</span><span id="line.254">    }</span>
<span class="source-line-no">255</span><span id="line.255"></span>
<span class="source-line-no">256</span><span id="line.256">}</span>




























































</pre>
</div>
</main>
</body>
</html>
